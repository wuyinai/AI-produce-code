<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wuyinai.wuaipdce.mapper.AppVersionMapper">

    <select id="getNextVersionNumber" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(version_number), 0) + 1
        FROM app_version
        WHERE app_id = #{appId} AND is_delete = 0
    </select>

    <select id="listVersionsByAppId" resultType="com.wuyinai.wuaipdce.model.entity.AppVersion">
        SELECT id, app_id, version_number, version_name, version_description,
               trigger_type, trigger_message, is_current, create_time, create_user_id
        FROM app_version
        WHERE app_id = #{appId} AND is_delete = 0
        ORDER BY version_number DESC
    </select>

    <select id="getCurrentVersionByAppId" resultType="com.wuyinai.wuaipdce.model.entity.AppVersion">
        SELECT id, app_id, version_number, version_name, version_description,
               code_snapshot, trigger_type, trigger_message, is_current,
               create_time, create_user_id
        FROM app_version
        WHERE app_id = #{appId} AND is_current = 1 AND is_delete = 0
        LIMIT 1
    </select>

    <update id="setAllVersionsNotCurrent">
        UPDATE app_version
        SET is_current = 0
        WHERE app_id = #{appId} AND is_delete = 0
    </update>

</mapper>
